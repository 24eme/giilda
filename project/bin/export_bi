#!/bin/bash

. bin/config.inc
. bin/import_functions.inc

curl -sX GET "http://$COUCHHOST:$COUCHPORT/$COUCHBASE/_design/configuration/_view/produits?reduce=false" | sed -f bin/unicode2alpha | grep "produits" | sed 's/"declaration\//"\/declaration\//g' | sed 's/\//\\\//g'| sed 's/null/""/' | awk -F ',' '{ print "s/" $7 "/\\0;" $9 "/" }' > $TMP/sed_produit_code

echo "#MOUVEMENT;type document;identifiant declarant;campagne;periode;document id; hash produit;code produit;type de mouvement;numero vrac du mouvement;detail identifiant;nom declarant;libelle produit;libelle type;volume mouvement;vrac destinataire;detail libelle;date;version document;cvo;facturable;identifiant mouvement;pays export (si export)" > $TMP/export_bi_mouvements.csv
curl http://$COUCHHOST:$COUCHPORT/$COUCHBASE/_design/mouvement/_view/consultation  | sed -f bin/unicode2alpha | sed 's/.*"key":\[/MOUVEMENT;/' | sed 's/\],"value":\[/,/' | sed 's/\]\},*//' | grep '^MOUVEMENT;"' | sed 's/,/;/g' | sed 's/\r*$/;/' | sed 's/null//g' | sed -f $TMP/sed_produit_code >> $TMP/export_bi_mouvements.csv

echo "#CONTRAT;campagne;statut;identifiant document;numero contrat;numero archive;identifiant acheteur;nom acheteur;identifiant vendeur; non vendeur;identifiant courtier;nom courtier;type de vente (VIN_VRAC, VIN_BOUTEILLE, RAISIN, MOUT); hash produit;code produit;libelle produit;volume propose (en hl);volume enleve (en hl);prix unitaire (en hl);prix unitaire definitif (en hl);prix variable (OUI, NON);contrat interne (OUI, NON);en attente de l'original (OUI, NON);type de contrat(SPOT, PLURIANNUEL);date de signature;date de statistiques;date de validation;millesime;type de produit (GENERIQUE, DOMAINE);domaine;part variable;repartition cvo;nature de la cvo (MARCHE_DEFINITIF, COMPENSATION, NON_FINANCIERE, VINAIGRERIE)" > $TMP/export_bi_contrats.csv
curl http://$COUCHHOST:$COUCHPORT/$COUCHBASE/_design/vrac/_view/history  | sed -f bin/unicode2alpha | sed 's/.*"value":\[/CONTRAT;/' | sed 's/\],"value":\[/,/' | sed 's/\]\},*//' | grep '^CONTRAT;' | grep -E ',"(NONSOLDE|SOLDE)",' | sed 's/,/;/g' | sed 's/\r*$/;/' | sed 's/null//g' | sed -r 's/(;[0-9]+\.[0-9]{2})[0-9]+;/\1;/g' | sed -f $TMP/sed_produit_code >> $TMP/export_bi_contrats.csv

echo "#DS;campagne;identifiant declarant;hash produit;code produit;periode;identifiant;volume stock;volume stock Ã©laboration;vci;reserve_qualitative;nom declarant;libelle produit" > $TMP/export_bi_dss.csv
curl http://$COUCHHOST:$COUCHPORT/$COUCHBASE/_design/ds/_view/stocks | sed -f bin/unicode2alpha | sed 's/.*"key":\[/DS;/' | sed 's/\],"value":\[*/,/' | sed 's/\]*\},*//' | grep '^DS;"' | sed 's/,/;/g' | sed 's/\r*$/;/' | sed 's/null//g' | sed 's/";;"/";"/' | sed -f $TMP/sed_produit_code >> $TMP/export_bi_dss.csv

echo "#REVENDIQUE;campagne;identifiant declarant;hash produit;code produit;region;document id;volume;nom declarant;libelle produit" > $TMP/export_bi_revendiques.csv
curl http://$COUCHHOST:$COUCHPORT/$COUCHBASE/_design/revendication/_view/stocks | sed -f bin/unicode2alpha | sed 's/.*"key":\[/REVENDIQUE;/' | sed 's/\],"value":\[*/,/' | sed 's/\]*\},*//' | grep '^REVENDIQUE;"' | sed 's/,/;/g' | sed 's/\r*$/;/' | sed 's/null//g' | sed 's/";;"/";"/' | sed -f $TMP/sed_produit_code >> $TMP/export_bi_revendiques.csv

echo "#ETABLISSEMENT;statut (ACTIF, SUSPENDU);famille;identifiant societe;identifiant interne;nom;identifiant;cvi;region viticole;raison sociale;siege.adresse;siege.commune;siege.code postal;no accises;carte pro;email;telephone;fax;recette locale identifiant societe;recette locale nom" > $TMP/export_bi_etablissements.csv > $TMP/export_bi_etablissements.csv
curl http://$COUCHHOST:$COUCHPORT/$COUCHBASE/_design/etablissement/_view/all?reduce=false | sed -f bin/unicode2alpha | sed 's/.*"key":\["INTERPRO-inter-loire",/ETABLISSEMENT;/' | sed 's/\],"value":\[*/,/' | sed 's/\]*\},*//' | grep '^ETABLISSEMENT;"' | sed 's/,/;/g' | sed 's/\r*$/;/' | sed 's/null//g'  >> $TMP/export_bi_etablissements.csv >> $TMP/export_bi_etablissements.csv

echo "#SOCIETE;statut (ACTIF, SUSPENDU);type societe (OPERATEUR, VITICULTEUR, NEGOCIANT, COURTIER, PRESSE, PARTENAIRE, DOUANE, INSTITUTION, HOTEL-RESTAURANT, AUTRE);identifiant interne;identifiant;code_comptable_client;code_comptable_fournisseur;type fournisseur;nom;nom abrege;cave cooperative (OUI, NON);siret;code naf;tva intracommunautaire;enseignes (enseigne1|enseigne2);adresse;code postal;ville;pays" > $TMP/export_bi_societes.csv
curl http://$COUCHHOST:$COUCHPORT/$COUCHBASE/_design/societe/_view/export | sed -f bin/unicode2alpha | sed 's/.*"key":\["INTERPRO-inter-loire",/SOCIETE;/' | sed 's/\],"value":\[*/,/' | sed 's/\]*\},*//' | grep '^SOCIETE;"' | sed 's/,/;/g' | sed 's/\r*$/;/' | sed 's/null//g' >> $TMP/export_bi_societes.csv

cat  $TMP/export_bi_societes.csv | grep -E ';"[PLV\|]*MDV[PLV\|]*";' > $TMP/MDV_Fournisseurs.csv
cat  $TMP/export_bi_societes.csv | grep -E ';"[MDV\|]*PLV[MDV\|]*";' > $TMP/PLV_Fournisseurs.csv

echo -n > $TMP/PLV_Clients.csv
cat  $TMP/export_bi_societes.csv | grep ';"VITICULTEUR";' >> $TMP/PLV_Clients.csv
cat  $TMP/export_bi_societes.csv | grep ';"NEGOCIANT";' >> $TMP/PLV_Clients.csv

cat data/import/configuration/produits.csv | sed -r 's/^/#PRODUIT;/' | sed -r 's/;#/;/' > $TMP/export_bi_produits.csv

cat data/export/constantes.csv > $TMP/export_bi_constantes.csv

cd $TMP
if test "$SAMBA_XLSOFT_IP" && test "$SAMBA_XLSOFT_SHARE" && test "$SAMBA_AUTH" && test "$SAMBA_XLSOFT_DIR" ; then
    smbclient //$SAMBA_XLSOFT_IP/$SAMBA_XLSOFT_SHARE -A $SAMBA_AUTH -c "cd $SAMBA_XLSOFT_DIR ; put export_bi_mouvements.csv ; put export_bi_dss.csv ; put export_bi_revendiques.csv ; put export_bi_etablissements.csv ; put export_bi_societes.csv ; put MDV_Fournisseurs.csv ; put PLV_Fournisseurs.csv ; put PLV_Clients.csv"
fi
cd -

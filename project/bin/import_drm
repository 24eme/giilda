#!/bin/bash

mkdir tmp;

encodage=$(file --mime-encoding cieso.csv | sed -r 's/^.+: //');
iconv -f $encodage -t utf-8 cieso.csv | grep -E "^10;2011" | sed -r 's/;$//' | awk -F ";" '{ print sprintf("%s%s%010d;%s", $1, $2, $3, $0) }' | sort > tmp/ciesco-utf8.csv;

encodage=$(file --mime-encoding cilso.csv | sed -r 's/^.+: //');
iconv -f $encodage -t utf-8 cilso.csv | grep -E "^10;2011" | sed -r 's/;$//' | awk -F ";" '{ print sprintf("%s%s%010d;%s", $1, $2, $3, $0) }' | sed -r 's/([0-9]+;)[0-9]+;[0-9]+;[0-9]+;/\1/' | sort > tmp/cilso-utf8.csv;

join -t ";" tmp/ciesco-utf8.csv tmp/cilso-utf8.csv | sed -r 's/^[0-9]+;//'> tmp/drm.csv

#!/bin/bash

. bin/config.inc

echo "Import de la configuration"

php symfony import:configuration || exit

echo Generation des vues

bash bin/views

if ! test "$1"; then
    echo "Téléchargement des données";
    . bin/download_redmine_file https://clients.actualys.com/attachments/download/4688/VINSDELOIRE_DATA.tar.gz /tmp/VINSDELOIRE_DATA.tar.gz
fi

SYMFODIR=$(pwd);

LOGDATE=$SYMFODIR/$(date +%Y%m%d%H%M%S_import_data.log)

{

if ! test "$1"; then

	echo "Dézippage";
	rm -rf /tmp/VINSDELOIRE_DATA 2>/dev/null
	mkdir /tmp/VINSDELOIRE_DATA 2> /dev/null 
	cd /tmp/VINSDELOIRE_DATA
	tar -xzf /tmp/VINSDELOIRE_DATA.tar.gz
fi

mkdir /tmp/VINSDELOIRE_DATA 2> /dev/null 
cd /tmp/VINSDELOIRE_DATA

DATADIR=$(pwd);

mkdir $DATADIR/tmp

echo "import des societes";

iconv -f ISO88591 -t UTF8 $DATADIR/cipar.csv > $DATADIR/tmp/cipar.utf8.csv
php symfony import:societe $DATADIR/tmp/cipar.utf8.csv

echo "Import des établissements";

php symfony import:etablissement --trace $DATADIR/etablissements.csv

echo "Import des vracs";

bash bin/import_data_vrac

php symfony import:vrac --trace $DATADIR/vracs.csv

echo "Import des drms";

bash bin/import_data_drm

php symfony import:drm --trace $DATADIR/drm.csv

echo "Import des DS"""

bash bin/import_data_ds

php symfony import:ds --trace $DATADIR/ds.csv

}

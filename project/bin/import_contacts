#!/bin/bash

. bin/config.inc
. bin/import_functions.inc

DATADIR=$TMP/VINSDELOIRE_DATA

echo "conversion des chais pour Ã©viter les doublons"
WORKINGDIR=$(pwd);

cd $DATADIR
bash $WORKINGDIR/bin/convert_chais $WORKINGDIR
cd -

echo "Import Societe"

mkdir -p $DATADIR/tmp 2> /dev/null

convert-utf8 $DATADIR/cipar.csv | sort -t ';' -k 2,2 > $DATADIR/tmp/cipar.utf8.csv
php symfony import:societe $DATADIR/tmp/cipar.utf8.csv

echo "Import Etablissement"

convert-utf8 $DATADIR/cifonct.csv | awk -F ';' '{print $3";"$2}' | sort -t ';' -k 1,1 > $DATADIR/tmp/cifonct_contact.utf8.csv
convert-utf8 $DATADIR/cicontact.csv | sed 's/; */;/g' | sed 's/ *;/;/g' | sort -t ';' -k 2 > $DATADIR/tmp/cicontact.utf8.csv
awk -F ';' '{print $2";"$20}' $DATADIR/tmp/cicontact.utf8.csv | grep -v '; *$' | sort -t ';' -k 1,1 | sed 's/$/;COURTIER;/' > $DATADIR/tmp/cartecourtier.csv
join -t ';' -1 1 -2 1 $DATADIR/tmp/cartecourtier.csv $DATADIR/tmp/cifonct_contact.utf8.csv | sort -t ';' -k 5,5 > $DATADIR/tmp/cartecourtier_cifonct.csv

convert-utf8  $DATADIR/cicav.csv | sed 's/\(10;[^;]*\);/\1_/' | sort -t ';' -k 2,2 > $DATADIR/tmp/cicav.utf8.csv
grep ';2012;' $DATADIR/cidra.csv  | sed 's/10;2012;\([^;]*\);\([^;]*\);.*/\1_\2;OUI/' | sort -t ';' -k1,1  > $DATADIR/tmp/daa.csv
join -t ';' -a 1 -1 2 -2 1 $DATADIR/tmp/cicav.utf8.csv $DATADIR/tmp/daa.csv | sed 's/;$/;NON/' | sed 's/_/;/' | sort -t ';' -k 1,1 | sed 's/^/10;/' > $DATADIR/tmp/cicav_daa.utf8.csv

join -t ';' -a 1 -1 2 -2 2 $DATADIR/tmp/cipar.utf8.csv $DATADIR/tmp/cicav_daa.utf8.csv > $DATADIR/etablissement.csv
join -t ';' -a 1 -1 1 -2 5 $DATADIR/etablissement.csv $DATADIR/tmp/cartecourtier_cifonct.csv > $DATADIR/etablissementsetcourtiers.csv
php symfony import:etablissement $DATADIR/etablissementsetcourtiers.csv

echo "Import Contact"

convert-utf8 $DATADIR/cifonct.csv | sort -t ';' -k 2,2 > $DATADIR/tmp/cifonct.utf8.csv
join -t ';' -1 2 -2 2 $DATADIR/tmp/cifonct.utf8.csv $DATADIR/tmp/cipar.utf8.csv | sort -t ';' -k 3,3 > $DATADIR/tmp/cifonct_cipar.utf8.csv
convert-utf8 $DATADIR/cicontact.csv | sed 's/; */;/g' | sed 's/ *;/;/g' | sort -t ';' -k 2,2 > $DATADIR/tmp/cicontact.utf8.csv
join -t ';' -1 2 -2 3 $DATADIR/tmp/cicontact.utf8.csv $DATADIR/tmp/cifonct_cipar.utf8.csv | sort -t ';' -k 2,2 -n  > $DATADIR/tmp/cicontact_cifonct_cipar.csv

php symfony import:compte $DATADIR/tmp/cicontact_cifonct_cipar.csv

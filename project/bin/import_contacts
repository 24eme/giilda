#!/bin/bash

. bin/config.inc
. bin/import_functions.inc

DATADIR=$TMP/VINSDELOIRE_DATA

echo "conversion des chais pour éviter les doublons"
WORKINGDIR=$(pwd);

cd $DATADIR
bash $WORKINGDIR/bin/convert_chais $WORKINGDIR "1/2"
cd -

mkdir -p $DATADIR/tmp 2> /dev/null

#Societe
convert-utf8 $DATADIR/cipar.uniq.csv | sort -t ';' -k 2,2 > $DATADIR/tmp/cipar.uniq.utf8.csv
convert-utf8 $DATADIR/cipar.csv | sort -t ';' -k 2,2 > $DATADIR/tmp/cipar.utf8.csv
sort -t ';' -k 5,5 $DATADIR/tmp/cipar.uniq.utf8.csv > $DATADIR/societes.csv

#Etablissement 

convert-utf8 $DATADIR/cifonct.csv | awk -F ';' '{print $3";"$2}' | sort -t ';' -k 1,1 > $DATADIR/tmp/cifonct_contact.utf8.csv
convert-utf8 $DATADIR/cicontact.csv | sed 's/; */;/g' | sed 's/ *;/;/g' | sort -t ';' -k 2 > $DATADIR/tmp/cicontact.utf8.csv
awk -F ';' '{print $2";"$20}' $DATADIR/tmp/cicontact.utf8.csv | grep -v '; *$' | sort -t ';' -k 1,1 | sed 's/$/;COURTIER;/' > $DATADIR/tmp/cartecourtier.csv
join -t ';' -1 1 -2 1 $DATADIR/tmp/cartecourtier.csv $DATADIR/tmp/cifonct_contact.utf8.csv | sort -t ';' -k 5,5 > $DATADIR/tmp/cartecourtier_cifonct.csv

convert-utf8  $DATADIR/cicav.viti.csv | sed 's/\(10;[^;]*\);/\1_/' | sort -t ';' -k 2,2 > $DATADIR/tmp/cicav.utf8.csv
grep ';2012;' $DATADIR/cidra.csv  | sed 's/10;2012;\([^;]*\);\([^;]*\);.*/\1_\2;OUI/' | sort -t ';' -k1,1  > $DATADIR/tmp/dra.csv
join -t ';' -a 1 -1 2 -2 1 $DATADIR/tmp/cicav.utf8.csv $DATADIR/tmp/dra.csv | sed 's/;$/;NON/' | sed 's/_/;/' | sort -t ';' -k 1,1 | sed 's/^/10;/' > $DATADIR/tmp/cicav_dra.utf8.csv

join -t ';' -a 1 -1 2 -2 2 $DATADIR/tmp/cipar.utf8.csv $DATADIR/tmp/cicav_dra.utf8.csv > $DATADIR/etablissement.csv
join -t ';' -a 1 -1 1 -2 5 $DATADIR/etablissement.csv $DATADIR/tmp/cartecourtier_cifonct.csv | sort -t ';' -k 5,5 > $DATADIR/etablissementsetcourtiers.csv

cd $DATADIR
bash $WORKINGDIR/bin/convert_chais $WORKINGDIR "2/2"
cd -

#Contacts
convert-utf8 $DATADIR/cifonct.csv | sort -t ';' -k 2,2 > $DATADIR/tmp/cifonct.utf8.csv
join -t ';' -1 2 -2 2 $DATADIR/tmp/cifonct.utf8.csv $DATADIR/tmp/cipar.utf8.csv | sort -t ';' -k 3,3 > $DATADIR/tmp/cifonct_cipar.utf8.csv
convert-utf8 $DATADIR/cicontact.csv | sed 's/; */;/g' | sed 's/ *;/;/g' | sort -t ';' -k 2,2 > $DATADIR/tmp/cicontact.utf8.csv
join -t ';' -1 2 -2 3 $DATADIR/tmp/cicontact.utf8.csv $DATADIR/tmp/cifonct_cipar.utf8.csv | sort -t ';' -k 2,2 -n | grep -v ';PARTENAIRE;' > $DATADIR/tmp/cicontact_cifonct_cipar.csv

echo "Import Societe"
php symfony import:societe $DATADIR/societes.csv

echo "Import Etablissement"
php symfony import:etablissement $DATADIR/etablissementsetcourtiers.csv

awk -F ';' '{print $1";"$2";"$3";"$4";"$5";"$6";"$7";"$8";"$9";"$10";"$11";"$12";"$13";"$14";"$15";"$16";"$17";"$18";"$19";"$20";"$21";"$22";"$23}' $DATADIR/tmp/cicontact_cifonct_cipar.csv | uniq > $DATADIR/tmp/contacts.csv

echo "Import Contact"
php symfony import:compte $DATADIR/tmp/contacts.csv

echo "Link bailleurs/métayés"

convert-utf8 $DATADIR/ciattinao.csv | awk -F ';' '{print $3";"$7";"$19}' | grep '[0-9]$' | sed 's/^ //g' | sort -t ';' -k 1,1 | sed 's/$/01/' > $DATADIR/tmp/bailleursmetayers.csv
curl -s http://$COUCHHOST:$COUCHPORT/$COUCHBASE/_design/etablissement/_view/findByCvi | grep '[0-9]"],"value' | sed 's/.*key":\["//' | sed 's/"\],"value":\["/;/' | sed 's/".*//'| sort -t ';' -k 1,1 > $DATADIR/tmp/cvi2idetab.csv
join -t ';' -1 1 -2 1 $DATADIR/tmp/cvi2idetab.csv $DATADIR/tmp/bailleursmetayers.csv | uniq > $DATADIR/tmp/idbailleursidmetayer.csv
php symfony import:metayerBailleur $DATADIR/tmp/idbailleursidmetayer.csv

echo "Import des mémos des sociétés"
convert-utf8 $DATADIR/cimemop.csv > $DATADIR/tmp/cimemop.utf8.csv
php symfony import:memo $DATADIR/tmp/cimemop.utf8.csv

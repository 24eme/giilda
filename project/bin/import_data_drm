#!/bin/bash

. bin/import_functions.inc

cd /tmp/VINSDELOIRE_DATA
DATADIR=$(pwd)

convert-utf8 $DATADIR/cimvs.csv | grep -E "^10;(2010|2011|2012)" | ajout-champ-commun '%06d%02d;%04d%02d;%04d;10.MOUVEMENT;%4d-%4d' '$3,$4,substr($7,7,4),substr($7,4,2),$5,$2,$2+1' > $DATADIR/drm-mouvement.csv

convert-utf8 $DATADIR/cimvsdiv.csv | grep -E "^10;(2010|2011|2012)" | ajout-champ-commun '%06d%02d;%04d%02d;%04d;05.DIVERS;%4d-%4d' '$5,$6,substr($11,7,4),substr($11,4,2),$7,$2,$2+1' > $DATADIR/drm-divers.csv

convert-utf8 $DATADIR/cimvscav.csv | grep -E "^10;(2010|2011|2012)" | ajout-champ-commun '%06d%02d;%04d%02d;%04d;06.CAVE-VITI;%4d-%4d' '$7,$8,substr($10,7,4),substr($10,4,2),$9,$2,$2+1' > $DATADIR/drm-cave-viti.csv

convert-utf8 $DATADIR/cimvscav.csv | grep -E "^10;(2010|2011|2012)" | ajout-champ-commun '%06d%02d;%04d%02d;%04d;07.CAVE-COOP;%4d-%4d' '$5,$6,substr($10,7,4),substr($10,4,2),$9,$2,$2+1' > $DATADIR/drm-cave-coop.csv

convert-utf8 $DATADIR/cieds.csv | grep -E "^10;(2010|2011|2012)" | ajout-champ-commun '%s%s%012d' '$1,$2,$3' | sort -n > $DATADIR/tmp/cieds-utf8.csv
convert-utf8 $DATADIR/cilds.csv | grep -E "^10;(2010|2011|2012)" | ajout-champ-commun '%s%s%012d' '$1,$2,$3' | sort -n > $DATADIR/tmp/cilds-utf8.csv
join -t ";" $DATADIR/tmp/cieds-utf8.csv $DATADIR/tmp/cilds-utf8.csv | suppression-champ-commun | ajout-champ-commun '%06d%02d;%04d%02d;%04d;01.DS;%4d-%4d' '$4,$5,$2+1,"08",$13,$2+1,$2+2' > $DATADIR/drm-ds.csv

convert-utf8 $DATADIR/cieso.csv | grep -E "^10;(2010|2011|2012)" | ajout-champ-commun '%s%s%012d' '$1,$2,$3' | sort -n > $DATADIR/tmp/cieso-utf8.csv
convert-utf8 $DATADIR/cilso.csv | grep -E "^10;(2010|2011|2012)" | ajout-champ-commun '%s%s%012d' '$1,$2,$3' | sort -n > $DATADIR/tmp/cilso-utf8.csv
join -t ";" $DATADIR/tmp/cieso-utf8.csv $DATADIR/tmp/cilso-utf8.csv | suppression-champ-commun | ajout-champ-commun '%06d%02d;%04d%02d;%04d;04.VENTE;%4d-%4d' '$5,$6,substr($11,7,4),substr($11,4,2),$17,$2,$2+1' > $DATADIR/drm-vente.csv

convert-utf8 $DATADIR/cienv.csv | grep -E "^10;(2010|2011|2012)" | ajout-champ-commun '%s%s%05d' '$1,$2,$3' | sort -n > $DATADIR/tmp/cienv-utf8.csv
convert-utf8 $DATADIR/cicon.csv | grep -E "^10;(2010|2011|2012)" | ajout-champ-commun '%s%s%05d' '$1,$2,$3' | sort -n > $DATADIR/tmp/cicon-cienv-utf8.csv
join -t ";" $DATADIR/tmp/cienv-utf8.csv $DATADIR/tmp/cicon-cienv-utf8.csv | suppression-champ-commun | ajout-champ-commun '%06d%02d;%04d%02d;%04d;02.CONTRAT;%4d-%4d' '$27,$28,substr($15,7,4),substr($15,4,2),$31,$2,$2+1' > $DATADIR/drm-contrat.csv

convert-utf8 $DATADIR/cieag.csv | grep -E "^10;(2010|2011|2012)" | ajout-champ-commun '%s%s%012d' '$1,$2,$3' | sort -n > $DATADIR/tmp/cieag-utf8.csv
convert-utf8 $DATADIR/cilag.csv | grep -E "^10;(2010|2011|2012)" | ajout-champ-commun '%s%s%012d' '$1,$2,$3' | sort -n > $DATADIR/tmp/cilag-utf8.csv
join -t ";" $DATADIR/tmp/cieag-utf8.csv $DATADIR/tmp/cilag-utf8.csv | suppression-champ-commun | ajout-champ-commun '%06d%02d;%04d%02d;%04d;03.ACHAT;%4d-%4d' '$4,$5,substr($22,7,4),substr($22,4,2),$13,$2,$2+1' > $DATADIR/drm-achat.csv

convert-utf8 $DATADIR/cicestrf.csv | grep -E "^10;(2010|2011|2012)" | ajout-champ-commun '%06d%02d;%04d%02d;%04d;09.TRANSFERT-SORTIE;%4d-%4d' '$5,$6,substr($10,7,4),substr($10,4,2),$9,$2,$2+1' > $DATADIR/drm-transfert-sortie.csv

convert-utf8 $DATADIR/cicestrf.csv | grep -E "^10;(2010|2011|2012)" | ajout-champ-commun '%06d%02d;%04d%02d;%04d;08.TRANSFERT-ENTREE;%4d-%4d' '$7,$8,substr($10,7,4),substr($10,4,2),$9,$2,$2+1' > $DATADIR/drm-transfert-entree.csv

cat $DATADIR/drm-mouvement.csv $DATADIR/drm-divers.csv $DATADIR/drm-cave-coop.csv $DATADIR/drm-cave-viti.csv $DATADIR/drm-vente.csv $DATADIR/drm-contrat.csv $DATADIR/drm-transfert-sortie.csv $DATADIR/drm-transfert-entree.csv $DATADIR/drm-achat.csv $DATADIR/drm-ds.csv | sort | grep -E "(20110[89]{1}|20111[0-2]{1}|2012[0-9]{2})" > $DATADIR/drm.csv

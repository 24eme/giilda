input {
	couchdb_changes {
		db => "COUCHBASE"
	}

}
filter {
  if [@metadata][_id] =~ /^DRM-.+$/ {
	mutate {
		add_field => { "type" => "%{[@metadata][_id]}" }
	}
	mutate {
		gsub => [
			"type", "^([A-Z]+)-.+$", "\1"
		]
	}
	ruby {
	    code => "
		identifiant = event['doc']['identifiant']
		mouvements = []
		if defined? event['doc']['mouvements'][identifiant]
			event['doc']['mouvements'][identifiant].each{|key, mvt|
				mouvements.push(mvt)
			}
		end
		event['doc']['mouvements'] = mouvements
		event['doc']['periode_date'] =  event['doc']['periode'] + '01'
	    "
	  }
	mutate {
	    remove_field => ["doc[declaratif]", "doc[declaration][certifications]", "doc[favoris]"]
	}
  } else { 
  	if [@metadata][_id] =~ /^VRAC-.+$/ {
        mutate {
                add_field => { "type" => "%{[@metadata][_id]}" }
        }
        mutate {
                gsub => [
                        "type", "^([A-Z]+)-.+$", "\1"
                ]
        }
  	} else { 
  		if [@metadata][_id] =~ /^COMPTE-.+$/ {
	        mutate {
	                add_field => { "type" => "%{[@metadata][_id]}" }
	        }
	        mutate {
	                gsub => [
	                        "type", "^([A-Z]+)-.+$", "\1"
	                ]
	        }
  		} else { 
	  		if [@metadata][_id] =~ /^ETABLISSEMENT-.+$/ {
		        mutate {
		                add_field => { "type" => "%{[@metadata][_id]}" }
		        }
		        mutate {
		                gsub => [
		                        "type", "^([A-Z]+)-.+$", "\1"
		                ]
		        }
  			} else { 
  				if [@metadata][_id] =~ /^SOCIETE-.+$/ {
			  		ruby {
					    code => "
						contacts = []
						etablissements = []
							event['doc']['contacts'].each{|key, mvt|
								contacts.push(mvt)
							}
							event['doc']['etablissements'].each{|key, mvt|
								etablissements.push(mvt)
							}
						event['doc']['contacts'] = contacts
						event['doc']['etablissements'] = etablissements
					    "
					  }
			        mutate {
			                add_field => { "type" => "%{[@metadata][_id]}" }
			        }
			        mutate {
			                gsub => [
			                        "type", "^([A-Z]+)-.+$", "\1"
			                ]
			        }
  				} else{
        			drop { }
  				} 
  			} 
  		} 
  	}
  }
}
output {
  if [@metadata][_id] =~ /^DRM-.+$/ {
	if [@metadata][action] == 'delete' {
                http {
                        http_method => "delete"
                        url => "http://ELASTHOST:ELASTPORT/ELASTBASE_drm/%{[type]}/%{[@metadata][_id]}"
                }
        } else {
                elasticsearch {
                        index => "ELASTBASE_drm"
                        document_id => "%{[@metadata][_id]}"
			flush_size => 10
			manage_template => false
                }
        }	
  } 
  if [@metadata][_id] =~ /^VRAC-.+$/ {
        if [@metadata][action] == 'delete' {
                http {
                        http_method => "delete"
                        url => "http://ELASTHOST:ELASTPORT/ELASTBASE_vrac/%{[type]}/%{[@metadata][_id]}"
                }
        } else {
                elasticsearch {
                        index => "ELASTBASE_vrac"
                        document_id => "%{[@metadata][_id]}"
                        flush_size => 10
                        manage_template => false
                }
        }
  }
  if [@metadata][_id] =~ /^COMPTE-.+$/ {
        if [@metadata][action] == 'delete' {
                http {
                        http_method => "delete"
                        url => "http://ELASTHOST:ELASTPORT/ELASTBASE_compte/COMPTE/%{[@metadata][_id]}"
                }
        } else {
                elasticsearch {
                        index => "ELASTBASE_compte"
                        document_id => "%{[@metadata][_id]}"
                        flush_size => 10
                        manage_template => false
                }
        }
  }
  if [@metadata][_id] =~ /^ETABLISSEMENT-.+$/ {
        if [@metadata][action] == 'delete' {
                http {
                        http_method => "delete"
                        url => "http://ELASTHOST:ELASTPORT/ELASTBASE_compte/COMPTE/%{[@metadata][_id]}"
                }
        } else {
                elasticsearch {
                        index => "ELASTBASE_compte"
                        document_id => "%{[@metadata][_id]}"
                        flush_size => 10
                        manage_template => false
                }
        }
  }
  if [@metadata][_id] =~ /^SOCIETE-.+$/ {
        if [@metadata][action] == 'delete' {
                http {
                        http_method => "delete"
                        url => "http://ELASTHOST:ELASTPORT/ELASTBASE_compte/COMPTE/%{[@metadata][_id]}"
                }
        } else {
                elasticsearch {
                        index => "ELASTBASE_compte"
                        document_id => "%{[@metadata][_id]}"
                        flush_size => 10
                        manage_template => false
                }
        }
  }
}

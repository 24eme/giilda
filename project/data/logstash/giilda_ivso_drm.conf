input {
	couchdb_changes {
		db => "giilda_ivso"
		initial_sequence => 0
	}

}
filter {
  if [@metadata][_id] !~ /^DRM-.+$/ {
	drop { }
  }
	mutate {
		add_field => { "type" => "%{[@metadata][_id]}" }
	}
	mutate {
		gsub => [
			"type", "^([A-Z]+)-.+$", "\1"
		]
	}
  ruby {
    code => "
	identifiant = event['doc']['identifiant']
	mouvements = []
	if defined? event['doc']['mouvements'][identifiant]
		event['doc']['mouvements'][identifiant].each{|key, mvt|
			mouvements.push(mvt)
		}
	end
	event['doc']['mouvements'] = mouvements
	event['doc']['periode_date'] =  event['doc']['periode'] + '01'
    "
  }
  mutate {
    remove_field => ["doc[declaratif]", "doc[declaration][certifications]", "doc[favoris]"]
  }
 
}
output {
if [@metadata][action] == 'delete' {
                http {
                        http_method => "delete"
                        url => "http://localhost:9200/giilda_ivso_drm/%{[type]}/%{[@metadata][_id]}"
                }
        } else {
                elasticsearch {
                        index => "drm"
                        document_id => "%{[@metadata][_id]}"
			flush_size => 10
			manage_template => false
                }
        }	

#stdout { codec => rubydebug }
}

input {
        couchdb_changes {
                db => "COUCHBASE"
				sequence_path => "COUCHBASE_couchdb_seq"
				tags => ["COUCHBASE"]
        }

}
filter {
	if "COUCHBASE" in [tags] {
        if [@metadata][_id] =~ /^DRM-.+$/ {
                mutate {
                        add_field => { "type" => "%{[@metadata][_id]}" }
                }
                mutate {
                        gsub => [
                                "type", "^([A-Z]+)-.+$", "\1"
                        ]
                }
                ruby {
                        code => "
                                identifiant = event['doc']['identifiant']
                                mouvements = []
                                if defined? event['doc']['mouvements'][identifiant] then
                                        event['doc']['mouvements'][identifiant].each{|key, mvt|
                                        		hash = /\/declaration\/certifications\/([a-zA-Z0-9]*)\/genres\/([a-zA-Z0-9]*)\/appellations\/([a-zA-Z0-9]*)\/mentions\/([a-zA-Z0-9]*)\/lieux\/([a-zA-Z0-9]*)\/couleurs\/([a-zA-Z0-9]*)\/cepages\/([a-zA-Z0-9]*)/.match(mvt['produit_hash'])
                                        		mvt['certification'] = hash[1]
                                        		mvt['genre'] = hash[2]
                                        		mvt['appellation'] = hash[3]
                                        		mvt['mention'] =  hash[4]
                                        		mvt['lieu'] =  hash[5]
                                        		mvt['couleur'] =  hash[6]
                                        		mvt['cepage'] =  hash[7]
                                                mouvements.push(mvt)
                                        }
                                end
                                event['doc']['mouvements'] = mouvements
                                event['doc']['periode_date'] =  event['doc']['periode'] + '01'
                        "
                }
                mutate {
                        remove_field => ["doc[declaratif]", "doc[declaration][certifications]", "doc[favoris]"]
                }
        } else if [@metadata][_id] =~ /^VRAC-.+$/ {
		mutate {
                        add_field => { "type" => "%{[@metadata][_id]}" }
                }
                mutate {
                        gsub => [
                                "type", "^([A-Z]+)-.+$", "\1"
                        ]
                }
        } else if [@metadata][_id] =~ /^COMPTE-.+$/ {
                mutate {
                        add_field => { "type" => "%{[@metadata][_id]}" }
                }
                mutate {
                        gsub => [
                                "type", "^([A-Z]+)-.+$", "\1"
                        ]
                }
        } else if [@metadata][_id] =~ /^ETABLISSEMENT-.+$/ {
                mutate {
                        add_field => { "type" => "%{[@metadata][_id]}" }
                }
                mutate {
                        gsub => [
                                "type", "^([A-Z]+)-.+$", "\1"
                        ]
                }
        } else if [@metadata][_id] =~ /^SOCIETE-.+$/ {
		ruby {
                        code => "
                                contacts = []
                                etablissements = []
                                if defined? event['doc']['contacts'] then
	                                event['doc']['contacts'].each{|key, mvt|
	                                        contacts.push(mvt)
	                                }
                                end
                                if defined? event['doc']['etablissements'] then
	                                event['doc']['etablissements'].each{|key, mvt|
	                                        etablissements.push(mvt)
	                                }
                                end
                                event['doc']['contacts'] = contacts
                                event['doc']['etablissements'] = etablissements
                        "
                }
                mutate {
                        add_field => { "type" => "%{[@metadata][_id]}" }
                }
                mutate {
                        gsub => [
                                "type", "^([A-Z]+)-.+$", "\1"
                        ]
                }
        } else {
                drop { }
        }
	}
}
output {
	if "COUCHBASE" in [tags] {
        if [@metadata][action] == 'delete' {
                http {
                        http_method => "delete"
                        url => "http://ELASTHOST:ELASTPORT/ELASTBASE/%{[type]}/%{[@metadata][_id]}"
                }
        } else {
                elasticsearch {
                        index => "ELASTBASE"
                        document_id => "%{[@metadata][_id]}"
                }
        }
	}
}

Documentation d'exploitation
============================

I. PrÃ©-requis Ãá l'installation
------------------------------

Configuration conseillÃ© de la machine :

* Processeur Ãá plusieurs coeurs
* 4 Go de MÃ©moire RAM au minimum, 8 idÃ©alement
* Disque dur de 300 Ãá 400 Go


Les autres informations nÃ©cessaire Ãá l'installation sont prÃ©sent dans la documentation technique.

II. Installation de linux
------------------------

L'installation de linux est trÃ©s bien dÃ©crite dans [ce livre](http://formation-debian.via.ecp.fr/intro-partie1.html).

### A. Distribution de linux

Les documentations sont obtimisÃ©es pour Debian.

Il faut prendre la deniÃ¿re version [stable](http://www.debian.org/distrib/).

### B. Partionnement des disques

L'idÃ©al est de partionner le disque avec LVM

Puis de tous mettre sur une seule partition.

### C. SÃ©lÃ©ction des logiciels

Il faut juste laisser cocher "Serveur SSH" et "Utilitaires standard du systÃ¿me"

Pour avoir une interface graphique, cocher "Environnement graphique de bureau", mais elle n'est pas nÃ©cÃ©ssaire pour le fonctionnement de l'application.

III. Architecture
----------------

![SchÃ©ma dÃ©crivant l'architecture de VINSI](images/architecture.jpg "SchÃ©ma de l'architecture")

[TÃ©lÃ©charger le schÃ©ma au format pdf](docs/architecture.pdf)

### A. Serveur applicatif

#### 1. Application

Symfony et apache

#### 2. Vhost

Deux instances prod et preprod 

DÃ©coupÃ© en trois virtual host : 

* production transaction
* production contact
* preprod

#### 3. Couchdb

Base de donnÃ©es documentaires

Une base pour la prod et une autre pour la prÃ©prod

L'interface utilisateur pour consulter les bases est :

http://url_du_serveur::5984/_utils/

#### 4. LDAP

Annuaire des interlocuteurs de prod. 

L'application verse les infos dans le LDAP, mais ne les utilise pas.

Infos de connexion:

* host : "ip_du_serveur"
* port : "389"
* base : "ou=people,dc=interloire,dc=tld"
* utilisateurs : vide

Configurer thunderbird pour relier le carnet d'adresse avec le LDAP :

![Configuration de thunderbird](images/configuration_thunderbird.jpg "Configuration de thunderbird")

#### 5. Elasticsearch

Moteur de recherche Ãá facettes alimentÃ© par couchdb.

Les documents indexÃ©s sont les sociÃ©tÃ©s, les Ã©tablissements, les interlocuteurs et les alertes 

La prÃ©prod et la prod ont chacune une base dans Elasticsearch.

L'interface utilisateur pour consulter les bases est :

http://url_du_serveur::9200/_plugin/head

### B. Serveur Active directory

Il contient la liste des utilisateurs interloire pouvant se connecter Ãá l'application.

Apache se charge d'interroger l'AD pour autentifier les utilisateurs

L'application y rÃ©cupÃ¿re le champ __description__ pour lui affecter ses droits (admin, transaction, contacts, presse, ...). 

### C. Serveurs de partage

L'application accÃ¿de Ãá ses serveurs via des clients Samba.

Configuration du serveur applicatif pour pouvoir monter le dossier backup du serveur de partage.

Ajouter dans le fichier /etc/fstab :

    //ip_du_serveur_de_partage/BackupVinsi/ /mnt/samba  cifs  rw,user,credentials=/path_to/.smbauthentication 0 0

Le fichier .smbauthentication doit Ã¬tre de la forme :

    username =login_samba
    password =mot_de_passe_samba
    domain   =INTERLOIRE

Il existe deux serveurs de partage, un partage principal et un autre spÃ©cifique pour le BI.

Ces serveurs de stockages permettent de stocker :

* Les factures en PDFs
* Les backups de couchdb
* Les fichiers d'Ã©changes avec SAGE
* Les exports BI

### D. Serveur de Backup

Il contient une instance de couchdb. Le serveur applicatif rÃ©plique de faÃºon permanente la base couchdb de la prod vers ce serveur.
Dans le cas oÃ¹ la base de prod serait corrompu, ce base peut Ã¬tre utilisÃ©e pour la restaurer.

Cette technique permet Ã©galement la sauvegarde cohÃ©rente et totale de la base qui est transfÃ©rÃ©e au serveur de partage sans interruption de service sur la production.

IV. Backups
-----------

### A. Couchdb : Sauvegarde et RÃ©cupÃ©ration de la base 

La rÃ©plication de la base de production vers celle de backup est automatisÃ©e.

Le serveur de backup possÃ¿de un cron (une tÃóche reccurente) qui vÃ©rifie toutes les minutes que la replication continue des donnÃ©es a bien lieu.

Cette tÃóche relance alors le processus de rÃ©plication continue si celle-ci s'Ã©tait suspendue.

Afin de possÃ©der une version quotidienne de la base de donnÃ©e, une tÃóche crÃ©er un dump de la base rÃ©pliquÃ©e et le tranfÃ¿re vers le serveur de partage toutes les nuits.

En cas de problÃ¿me ou de perte de la base de donnÃ©e de production, il est possible de rÃ©cupÃ©rer cette version sauvegardÃ©e de la base depuis le serveur de partage.

Ceci peut se faire comme suit :

Passer par l'interface couchdb futon afin de rÃ©pliquer la base sauvegardÃ©e dans le serveur de backup vers la base de production.

NÃ©anmoins, si la base de backup est elle aussi inexistente ou inaccessible, il faudra rÃ©cupÃ©rer le dump sur le serveur de partage, et l'installer en production en procÃ©dant ainsi :

1. ArrÃ¬ter le service couchdb sur le serveur de production
2. Ãëcraser les fichiers de la base de donnÃ©e couchdb actuelle de production par ceux du serveur de rÃ©cupÃ©ration
3. Re-dÃ©marrer le service couchdb sur le serveur de production

Pour en savoir plus sur la rÃ©plication continue dans CouchDB : http://guide.couchdb.org/draft/replication.html#continuous

V. Administration du fichier de paramÃ©trage "app.yml"
--------------------------------------------------

### A. AccÃ©der et modifier le fichier

#### 1. Editer le fichier app.yml

Se prÃ©munir d'un Ã©diteur de texte ([Liste des Ã©diteurs texte sour linux](http://fr.wikipedia.org/wiki/%C3%89diteur_de_texte#Sous_UNIX_.2F_Linux)).

Depuis la racine du projet, editer le fichier project/config/app.yml

Le fichier app.yml est au format YAML, qui nÃ©cessite une comprÃ©hension et le respect de certaines rÃ¿gles.

**Les fichiers YAML**

[Documentation du format YAML](http://fr.wikipedia.org/wiki/YAML)

Ce qu'il faut retenir sur le format YML

Il s'agit d'une structure en arbre oÃ¹ chaque niveau est reprÃ©sentÃ© par une indentation de deux espaces.

/!\ Pour l'indentation, il faut bien s'assurer de ne pas insÃ©rer un caractÃ¿re "Tab" Ãá la place des espaces.

Le # permet de mettre en commentaire la suite de la ligne.

#### 2. Tester son fonctionnement

Ce fichier est mis en cache, donc sa modification ne sera pas prise en compte dans l'appli tant que le cache n'est pas vidÃ©.

Il est possible de tester l'appli en mode "dev", pour vÃ©rifier son bon fonctionnement, avant de l'appliquer.

Mode dÃ©v : http://url_de_lappli/vinsdeloire_dev.php

#### 3. Vider le cache

Si tout est ok, voici la procÃ©dure pour vider le cache :

Ouvrir un terminal et lancer les commandes suivantes :

    > cd /path_to_project/project
    > sudo -u www-data php symfony cc

Pour vÃ©rifier que l'app.yml est bien pris en compte bien penser Ãá retirer vinsdeloire_dev.php de l'url

### B. ParamÃ©trages des alertes

Pour bien comprendre, voici un petit rappel des statuts d'une alerte :

* Nouveau : Statut mis automatiquement Ãá la crÃ©ation d'une alerte
* A traiter : Il s'agit d'un statut qui implique les mÃ¬me changement fonctionnels que le statut "Nouveau", mais qui permet Ãá l'opÃ©rateur de trier ses alertes 
* En attente de rÃ©ponse: Ce statut peut Ã¬tre passÃ© humainement pour indiquer une attente de document ou autre, ou bien automatiquement aprÃ¿s l'envoi d'une relance.
* A relancer : Statut qui (appliquÃ© de maniÃ¿re automatique ou manuel) engendre la gÃ©nÃ©ration d'un courrier de relance.
* RÃ©solu : Statut pour indiquer manuellement que l'alerte a Ã©tÃ© rÃ©solu
* FermÃ© : Le statut fermÃ© est un statut automatique lorsque l'alerte est rÃ©solu mais non passÃ© au statut "RÃ©solu".
* En sommeil : Le statut en sommeil est un statut qui n'est pas relancable

Structure de la partie "alertes" du fichier app.yml :


    all:
      ...
      alertes:
        generations:
          TITRE_RELANCE:
            class: CLASS_RELACE
            creation_delai: '-6 month'
            relance_delai: '+1 month'
            relance_date: '15/12'
            enattente_delai: '+1 month'
            enattente_date: '15/12'
            nb_relance: '2'
            nb_campagne: '1'
            seuil: '10'
        ...

Le paramÃ©trage des alertes s'effectue individuellement pour chacune d'elle Ãá l'aide d'attributs. Ces attributs permettent de dÃ©finir au bout de combien de temps lever l'alerte, quand la relancer, combien de fois, sur combien de campagne ou encore dans certain cas dÃ©finir un pourcentage de seuil (pour les alertes d'Ã©carts)

Liste des attributs :

* class : Classe PHP de la relance (ne pas modifier)

* crÃ©ation_date (type: date sans annÃ©e au format jour/mois) : Date Ãá laquelle l'alerte sera levÃ©. Par exemple pour les contrats non soldÃ©s, si la "crÃ©ation_date" est le 15/06, tous les 15 juin de chaque annÃ©e, l'ensemble des contrats non soldÃ© leveront une alerte.

* crÃ©ation_delai (type: durÃ©e relative) : Interval de temps au bout duquel l'alerte est crÃ©e, exemple pour les contrats non soldÃ©s l'interval de temps est Ãá '-6 month'. Ce qui signifie que l'alerte est levÃ© 6 mois aprÃ©s la date de saisie d'un contrat qui est toujours non soldÃ©. Pour cet attribut la date relative doit Ã¬tre nÃ©gative (avec le signe '-' en dÃ©but)

* relance_delai (type: durÃ©e relative) : Interval de temps (par rapport Ãá la crÃ©ation de l'alerte) au bout duquel une alerte au statut "Nouveau" ou "A traiter" passera automatiquement au statut Ãá relancer. Cette durÃ©e relative doit Ã¬tre positive.

* relance_date (type: date sans l'annÃ©e) : Date Ãá laquelle une alerte au statut "Nouveau" ou "A traiter" passera automatiquement au statut Ãá relancer

* enattente_delai (type: durÃ©e relative) : Interval de temps entre le passage au statut "En attente de rÃ©ponse" le prochain passage au statut "Ãá relancer". Pour cet attribut la durÃ©e doit Ã¬tre positive (avec le signe + en dÃ©but)

* enattente_date (type: date sans l'annÃ©e) : Date Ãá laquelle une alerte au statut "En attente de rÃ©ponse" passera automatiquement au statut Ãá relancer

* nb_relance (type: nombre entier) : Nombre de relance automatique maximum d'une alerte avant que celle-ci passe au statut en sommeil. L'alerte sera toujours relancable manuellement.

* seuil (type: nombre entier, pourcentage) : Sert Ãá configurer un seuil de tolÃ©rance, notamment dans les Ã©carts.

* nb_campagne (type: nombre entier) : Nombre de campagne Ãá partir de la campagne courante sur laquelle appliquer la gÃ©nÃ©ration d'alerte.

/?\ les attributs "xxxxxxx_delai" et les "xxxxxxx_date" sont cumulatifs, par exemple on peut trÃ©s bien avoir "relance_delai" Ãá 1 mois avec "relance_date" le 1er Janvier, les deux s'appliqueront.


Type d'attribut particulier :

* DurÃ©e relative : 
    C'est une chaine de caractÃ¿res qui entre en compte dans le calcul d'une date Ãá partir d'une autre date. Exemple '-1 month' avec une date au 1er fÃ©vrier 2013 donnera la date du 1er janvier 2013.
    Exemple de syntaxe :
    * '-1 month +2 day' => 1 mois moins 2 jours avant la date du jour
    * 'last day of next month' => le dernier jour du prochain mois
    [Documentation complÃ¿te du format](http://fr2.php.net/manual/fr/datetime.formats.relative.php)

* Date sans l'annÃ©e :
    C'est une chaine de caractÃ¿re dÃ©crivant une date sans annÃ©e. Elle doit Ã¬tre au format 'dd/mm', par exemple le '15/06' correspond au 15 juin.

Liste des alertes :

* VRAC_NON_SOLDE : Contrats non soldÃ©

* VRAC_PRIX_DEFINITIFS : Contrats Ãá prix variable n'ayant pas de prix dÃ©finitif

* VRAC_ATTENTE_ORIGINAL : Contrats en attente de l'original

* DRM_MANQUANTE : DRM manquantes, une DRM est considÃ©rÃ© manquante par rapport Ãá la pÃ©riode de la DRM la plus rÃ©cente

* DRA_MANQUANTE : DRA manquante, une DRA est considÃ©rÃ© manquante par rapport Ãá la pÃ©riode de la DRA la plus rÃ©cente

* DRM_STOCK_NEGATIF : DRM dont le stock d'un ou plusieurs produits est nÃ©gatif

* SV12_MANQUANTE : SV12 manquante, une SV12 est considÃ©rÃ© manquante par rapport Ãá la pÃ©riode de la SV12 la plus rÃ©cente

* VRAC_SANS_SV12 : Contrats qui n'ont pas Ã©tÃ© inclus dans une SV12

* DS_NON_VALIDEE : DS non validÃ©e

* ECART_DS_DRM_JUILLET : Ecart de volume (produit par produit) supÃ©rieur Ãá un "seuil" de N% entre la DS et le stock fin de mois de la DRM de juillet

* ECART_DS_DRM_AOUT : Ecart de volume (produit par produit) supÃ©rieur Ãá un "seuil" de N% entre la DS et le stock dÃ©but de mois de la DRM d'aoÃ¯t

* ECART_DREV_DRM : Ecart de volume (produit par produit) supÃ©rieur Ãá un "seuil" de N% entre entre le stock rÃ©vendiquÃ© par l'ODG et celui revendiquÃ© dans la DRM

### C. En-tÃ¬te des factures

Structure de la partie "facture" du fichier app.yml :


    all:
      ...
      facture:
        emetteur:
          TOURS:
            adresse: 'adresse tours'
            code_postal: 'cp tours'
            ville: 'tours'
            service_facturation: 'nom prenom personne'
            telephone: 'tel tours - fax tours'
            email: 'emaildetours@tours.fr'
          ANGERS:
            adresse: 'adresse angers'
            code_postal: 'cp angers'
            ville: 'angers'
            service_facturation: 'nom prenom personne'
            telephone: 'tel angers - fax angers'
            email: 'emaildangers@angers.fr'
          NANTES:
            adresse: 'adresse nantes'
            code_postal: 'cp nantes'
            ville: 'nantes'
            service_facturation: 'nom prenom personne'
            telephone: 'tel nantes - fax nantes'
            email: 'emaildenantes@nantes.fr'
        ...

    /!\ Si il y a une apstrophe dans l'un des noms il faut l'Ã©chapper c'est Ãá dire rajouter "\" devant soit "\'"


### D. Contenances

Dans les contrats bouteilles la liste des contenances est administrable

Structure de la partie "contrat" du fichier app.yml :


    all:
      ...
      vrac:
        contenances: #volume exprimÃ© en hl
          "37,5 cl": 0.00375
          "50 cl": 0.005
          "75 cl": 0.0075
          "100 cl": 0.01
          "150 cl": 0.015
          "300 cl": 0.03
          "500 cl": 0.05
          "600 cl": 0.06
          "BIB 3l": 0.03
          "BIB 5l": 0.05
          "BIB 6l": 0.06
          "BIB 10l": 0.1
          "BIB 20l": 0.2
      ...


Pour ajouter une contenance, il faut donc ajouter une ligne du type : "libellÃ©": 0.00 (avec le volume exprimÃ© en hectolitre)

    /!\ La suppression d'une ligne de contenance est dÃ©conseillÃ©e, il faut mieux contacter l'Ã©quipe technique avant

### E. En-tÃ¬te des courriers de relance

Structure de la partie "relance" du fichier app.yml :


    all:
      ...
      relance:
        responsable_financier: 'prenom nom'
        emetteur:
          TOURS:
            adresse: 'adresse tours'
            code_postal: 'cp tours'
            ville: 'tours'
            services_operateurs:
              - {nom: 'prenom nom', telephone: 'TÃ©l : 00 00 00 00 00', email: 'emaildetours@tours.fr'}
              - {nom: 'prenom nom', telephone: 'TÃ©l : 00 00 00 00 00', email: 'emaildetours@tours.fr'}
          ANGERS:
            adresse: 'adresse angers'
            code_postal: 'cp angers'
            ville: 'angers'
            services_operateurs:
              - {nom: 'prenom nom', telephone: 'TÃ©l : 00 00 00 00 00', email: 'emaildangers@angers.fr'}
              - {nom: 'prenom nom', telephone: 'TÃ©l : 00 00 00 00 00', email: 'emaildangers@angers.fr'}
          NANTES:
            adresse: 'adresse nantes'
            code_postal: 'cp nantes'
            ville: 'nantes'
            services_operateurs:
             - {nom: 'prenom nom', telephone: 'TÃ©l : 00 00 00 00 00', email: 'emaildenantes@nantes.fr'}
             - {nom: 'prenom nom', telephone: 'TÃ©l : 00 00 00 00 00', email: 'emaildenantes@nantes.fr'}
        ...


Les champs Ãá Ã©diter sont ceux entre simple quote "''" qui se situe aprÃ¿s ":".

Les services opÃ©rateurs de chaque ville peuvent Ã¬tre multiples. Les attributs (nom, telephone, email) de chaque opÃ©rateur sont sur une ligne entre {} et sÃ©parÃ© par des virgules.

    /!\ Si il y a une apostrophe dans l'un des noms il faut l'Ã©chapper c'est Ãá dire rajouter "\" devant soit "\'"

### E. LDAP

### F. Active directory

VI. Exports, CRON et SAGE
---------------

### E. Exports et CRON

* GÃ©nÃ©ration des PDFs, toutes les minutes.

* GÃ©nÃ©ration et mise Ãá jour des alertes Ãá 03h00.

* Export BI vers le serveur de partage BI Ãá 21h00 (en prod uniquement)

* Export Sage vers le serveur de partage Ãá 21h30 (en prod uniqument)

* Flag des factures intÃ©grÃ©s dans sage et export PDF de ces factures vers le serveur de partage Ãá 23h45 (en prod uniqument)

### B. Echanges avec SAGE

Les Ã©changes avec SAGE sont rÃ©alisÃ©s, tous les jours. Il s'effectue en plusieurs etapes.

#### 1. Export pour SAGE

1. RÃ©cupÃ¿ration du fichier gÃ©nÃ©rÃ© par sage InfosClientsSage.txt. Si celui-ci n'existe pas, l'opÃ©ration s'arrÃ¬te.

2. Test de la non existence du fichier VinsiClientsSage.txt sur le serveur de partage. Sa prÃ©sence signifie qu'un import n'a pas pas correctement Ã©tÃ© intÃ©grÃ© dans SAGE. Si c'est le cas, l'opÃ©ration s'arrÃ¬te.

3. Suppression des fichiers societes.csv et factures.csv du serveur de partage

4. Export CSV des sociÃ©tÃ©s aggrÃ©gÃ© des infos contenus dans InfosClientsSage.txt: societes.csv

5. Export CSV des factures non intÃ©grÃ©es dans SAGE : factures.csv

6. Construction du fichier SAGE Ãá l'aide des deux CSV (societes.csv et factures.csv) : VinsiClientsSage.txt

7. Transfert des fichiers VinsiClientsSage.txt, societes.csv et factures.csv vers le serveur de partage dans le dossier //adresse_ip/Sage/Export/

#### 2. IntÃ©gration SAGE

SAGE importe le fichier VinsiClientsSage.txt dÃ©posÃ© sur le serveur de partage, si tout ce passe bien il supprime le fichier.

#### 3. Post traitement

1. L'application vÃ©rifie que les tÃóches prÃ©cÃ©dentes ce sont bien dÃ©roulÃ©es en vÃ©rifiant la prÃ©sence des fichiers societes.csv et factures.csv. Si ils n'existent pas, l'opÃ©ration s'arrete.

2. Pour vÃ©rifier que l'import dans SAGE s'est bien passÃ©, on teste la non prÃ©sence du fichier VinsiClientsSage.txt. Si il est prÃ©sent, l'opÃ©ration s'arrÃ¿te.

3. RÃ©cupÃ©ration des fichiers societes.csv et factures.csv depuis le serveur de partage

4. Archivage du fichier societes.csv dans le dossier data/factures/csv/date_du_jour/ et data/factures/csv/societes.last.csv de l'application.

5. Archivage du fichier factures.csv dans le dossier data/factures/csv/date_du_jour/ de l'application.

6. Export PDF des factures non intÃ©grÃ© dans le dossier data/factures/ de l'application puis sur le serveur de partage dans le dossier //ip_du_serveur_de_partage/BackupVinsi/. 

7. Flag dans couchdb des factures contenues dans le fichier factures.csv rÃ©cupÃ©rÃ©s.

8. Suppression des fichiers societes.csv et factures.csv du serveurs de partage.

AprÃ¿s tout ceci, qu'il y ai eu des erreurs ou non, un mail bilan est envoyÃ©.

#### 4. GÃ©rer les erreurs

**ERREUR le fichier InfosClientsSage.txt n'est pas present**

Le fichier InfosClientsSage.txt n'a pas pu Ã¬tre rÃ©cupÃ©rÃ© depuis le serveur de partage.

Il faut s'assurer que le fichier existe bien et qu'il est accessible pour la prochaine gÃ©nÃ©ration.

**ERREUR le fichier VinsiClientsSage.txt ne devrait pas Ã¬tre present**
et
**ERREUR IMPORT SAGE (le fichier VinsiClientsSage.txt ne devrait pas Ã¬tre present)**

Si cette erreur survient, c'est que SAGE n'a pas supprimÃ© le fichier et donc que l'import ne s'est pas bien passÃ©.

Il faut donc regarder pourquoi SAGE n'a pas rÃ©ussi Ãá importÃ© le fichier, deux cas possibles :

1. Si ce n'est pas liÃ© Ãá une erreur dans le fichier VinsiClientsSage.txt, et qu'on peut estimer que SAGE pourra l'importer la prochaine fois, il n'y a rien Ãá faire.

2. Si c'est liÃ© Ãá une erreur dans le fichier VinsiClientsSage.txt, il faut comprendre d'ou vient l'erreur et faire le nÃ©cessaire pour que la gÃ©nÃ©ration ne produise plus l'erreur, puis supprimer le fichier VinsiClientsSage.txt du serveur de partage. Il ne reste plus qu'a attendre la prochaine gÃ©nÃ©ration.

**ERREUR le fichier societes.csv n'a pas Ã©tÃ© trouvÃ© sur le rÃ©pertoire de partage**
et
**ERREUR le fichier factures.csv n'a pas Ã©tÃ© trouvÃ© sur le rÃ©pertoire de partage**

Il s'agit surement d'un bug dans l'application, qu'il faut corrigÃ©.

VII. Administration de CouchDB
-------------------------

### A. AccÃ¿s Ãá CouchDB

L'accÃ¿s Ãá CouchDB se fait via un navigateur web.

URL : http://url_appli:5984/_utils/

### B. Supprimer des documents

A partir de l'interface de CouchDB

#### 1. SÃ©lÃ©ctionnez une base de donnÃ©es

SÃ©lÃ©ctionnez une base de donnÃ©e

![Interface couchdb Futon](images/couchdb_futon.jpg "Interface couchdb Futon")

#### 2. Chercher le document Ãá supprimer

Les documents supprimables via CouchDB sont les DRM, SV12, VRAC (contrats), DS (Les DRev peuvent Ã¬tre supprimÃ© via l'appli).

Liste de la structure des identifiants des documents : 

* DRM-IDENTIFIANT-YYYYMM(-MXX)
* SV12-IDENTIFIANT-YYYY-YYYY(-MXX)
* VRAC-DATEXXX
* DS-IDENTIFIANT-YYYYMM

Le champs de recherche est en autocomplÃ©tion sur l'id du document (ceci peut permettre de voir l'existence d'une modificatrice par exemple).

![Recherche de doc couchdb](images/couchdb_recherche_doc.jpg "Recherche de doc couchdb")

#### 3. VÃ©rification

**DRM et SV12**

VÃ©rifier que le document n'est pas facturÃ©. Cette vÃ©rification peut se faire directement dans le document CouchDB, il faut regarder le noeud "mouvements", pour chacun d'eux contrÃ´ler que le champs "facture" est Ãá 0. 

VÃ©rifier que le document ne possÃ¿de pas de version modificatrice (version supÃ©rieure). Pour cela il faut contrÃ´ler la non existence du document en incrÃ©mentant la version Ãá la fin du document "-MXX" +1 (si cette partie n'existe pas l'ajouter en commencant Ãá 1, soit M-01).

**Contrat**

VÃ©rifier que le document n'est pas dans une SV12 ou dans une DRM directement dans l'application.


#### 4. Supprimer le document

Supprimer le document Ãá l'aide du bouton "Delete Document"

![Suppression de doc couchdb](images/couchdb_suppression_doc.jpg "Suppression de doc couchdb")

VIII. Structure des documents de la base Couchdb
-----------------------------------------------

Les bases de donnÃ©es NoSQL, permettent de stocker des documents au format [JSON](http://fr.wikipedia.org/wiki/JavaScript_Object_Notation).

La base ne possÃ¿de par rÃ©ellement de schema. La structure est libre et les documents ne sont pas reliÃ© entre eux.

En revanche une structure de documents a Ã©tÃ© dÃ©finis au niveau applicatif.

Un autre enjeu dans les base de donnÃ©es NoSQL sont les identifiants de documents, ils permettent de retrouver un document rapidement.

### A. Configuration

La configuration permet de stocker l'arbre produit.

[Voir la structure du document au format JSON](schema/configuration.json)

**Structure de l'identifiant**

Pour le moment, il en existe un seul qui se nomme "CONFIGURATION".

### B. Contrat

[Voir la structure du document au format JSON](schema/vrac.json)

**Structure de l'identifiant**

"VRAC-[DATE\_AU\_FORMAT\_YYYYMMDD][NUMERO\_INCREMENTAL\_SUR\_3\_CHIFFRES]"

par exemple : "VRAC-2013011100033"

### C. DRM

[Voir la structure du document au format JSON](schema/drm.json)

**Structure de l'identifiant**

"DRM-[IDENTIFIANT\_ETABLISSEMENT]-[PERIODE\_AU\_FORMAT\_YYYYMM]\(-M[NUMERO\_DE\_VERSION\_SUR\_2\_CHIFFRES]\)" (ce qui est entre parenthÃ¿se est optionnel)

Les documents soumis Ãá facturation sont versionnÃ©s, pour garantir la cohÃ©rence ce qui a Ã©tÃ© facturÃ© ou non.

par exemple : "DRM-11000001-200211" (version 0 du document) ou "DRM-11000001-200211-M01" (version 1 du document)

### D. SV12

[Voir la structure du document au format JSON](schema/sv12.json)

**Structure de l'identifiant**

"SV12-[IDENTIFIANT\_ETABLISSEMENT]-[CAMPAGNE\_AU\_FORMAT\_YYYY-YYYY]\(-M[NUMERO\_DE\_VERSION\_SUR\_2\_CHIFFRES]\)" (ce qui est entre parenthÃ¿se est optionnel)

Les documents soumis Ãá facturation sont versionnÃ©s, pour garantir la cohÃ©rence ce qui a Ã©tÃ© facturÃ© ou non.

par exemple : "SV12-40000901-2002-2003" (version 0 du document) ou "SV12-40000901-2002-2003-M01" (version 1 du document)

### E. DS

[Voir la structure du document au format JSON](schema/ds.json)

**Structure de l'identifiant**

"DS-[IDENTIFIANT\_ETABLISSEMENT]-[PERIODE\_AU\_FORMAT\_YYYYMM]"

par exemple :  "DS-11000101-201007"

### F. Facture

[Voir la structure du document au format JSON](schema/facture.json)

**Structure de l'identifiant**

"FACTURE-[ID\_SOCIETE]-[DATE\_AU\_FORMAT\_YYYYMMDD][NUMERO\_INCREMENTAL\_SUR\_2\_CHIFFRES]"

par exemple :  "FACTURE-110002-2013061901"

### G. Generation

Les documents de gÃ©nÃ©rations servent Ãá gÃ©nÃ©rer les PDFs.

[Voir la structure du document au format JSON](schema/generation.json)

**Structure de l'identifiant**

"GENERATION-[TYPE\_DE\_DOCUMENT]-[DATE\_AU\_FORMAT\_YYYYMMDD][TEMPS\_AU\_FORMAT\_HHMMSS]"

par exemple : "GENERATION-FACTURE-20130301100859" ou "GENERATION-DS-20130115101813"

### H. Alerte

[Voir la structure du document au format JSON](schema/alerte.json)

**Structure de l'identifiant**

"ALERTE-[TYPE\_DE\_L'ALERTE]-[IDENTIFIANT\_DU\_DOCUMENT]"

par exemple : "ALERTE-DRM\_MANQUANTE-DRM-11000101-201108" ou "ALERTE-VRAC\_ATTENTE\_ORIGINAL-VRAC-2010070107629"

### I. Societe

[Voir la structure du document au format JSON](schema/societe.json)

**Structure de l'identifiant**

"SOCIETE-[IDENTIFIANT\_SOCIETE\_SUR\_6\_CHIFFRES]"

par exemple : "SOCIETE-060001"

### J. Etablissement

[Voir la structure du document au format JSON](schema/etablissement.json)

**Structure de l'identifiant**

"ETABLISSEMENT-[IDENTIFIANT\_SOCIETE\_SUR\_6\_CHIFFRES][IDENTIFIANT\_CHAI\_SUR\_2\_CHIFFRES]"

par exemple : "ETABLISSEMENT-06000101"

### K. Compte

[Voir la structure du document au format JSON](schema/compte.json)

**Structure de l'identifiant**

"COMPTE-[IDENTIFIANT\_SOCIETE][NUMERO\_INCREMENTAL\_SUR\_2\_CHIFFRES]"

par exemple : "COMPTE-06000101"

IX. Mise en production de l'application
-----------------------------------------------

### A. VÃ©rification prÃ©liminaire

* VÃ©rifier les changements effectuÃ©s parfois Ãá la volÃ©e sur le serveur de production avec 
> git status

Si des changements dans l'arborescence de l'application ont Ã©tÃ© effectuÃ©es il faut les checkouter et les inclure dans le projet versionnÃ©.

* VÃ©rifier qu'il n'y aie aucune vue couchdb qui ait changÃ©. Si tel est le cas il faut les modifier directement dans l'interface Futon de couchDb.

* VÃ©rifier les changement de Configuration (liÃ©es Ãá l'object Configuration) auquel cas ces changement doivent eux aussi Ã¬tre passÃ© sur CouchDb.

* VÃ©rifier les fichiers de conf de l'application et modifier ceux-ci sur le serveur avec vi s'ils sont modifiÃ©s.
 

### B. TAGGING de la version de l'application

* VÃ©rifier que tout les submodule soit bien Ãá jour avec git submodule update Ãá la racine

* Lister les diffÃ©rentes version de l'application avec 
 > git tag

afin de repÃ©rer la derniÃ¿re version de mise en production.

* Tagger le version de l'application avec 
 > git tag -a nouvelle_version -m 'commentaire'

on utilise comme commentaire la date du jour du tagging et pour le nom de version VINSI-X.X

Il faudra ensuite faire
 > git push origin VINSI-X.X

pour pusher sur le serveur git le tag de version de l'application. 

### C. Mettre Ãá jour l'application

On utilise
 > git fetch
 > git checkout VINSI-X.X
 > git submodule update
 > php symfony cc
Ãá la racine de l'application pour mettre Ãá jour le projet
